# 全网最新-运维老炮傻瓜式教你搭建Sentry最新版21.11.0，不会运维也能搭建

##  购买ECS

#### 购买华为云弹性云服务

作者作为一名打工人有点穷，对比了一下金山云 、阿里云、 华为云后发现华为云较便宜，所以我选择了华为云，其实其他云厂商都大同小异，这一步知识教大家如何购买ECS，很简单

华为云控制台网站：https://account.huaweicloud.com

sentry本地部署版地址：https://github.com/getsentry/onpremise

sentry官方要求最低4核8G，我们这是购买的是`8核16G` 的ECS ![image-20211120200423088](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120200423088.png)

1. 选择控制台-弹性云服务器ECS

![image-20211120190951220](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120190951220.png)

2. 左上角选择-`购买弹性云服务器` 

![image-20211120191048169](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120191048169.png)

3. 选按需计费-乌兰察布区-8核16G（都是穷闹的，这一步土豪请随意）

![image-20211120140604976](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120140604976.png)

4. 公共镜像-Centos-Centos8.2-下一步

![image-20211120140634093](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120140634093.png)

5. 网络-自己选一个默认的就行（这是为了测试，生产环境中要按照生产环境规范来选择网络环境），

   弹性公网IP-选择按流量计费-5M（土豪请随意）

![image-20211120140911486](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120140911486.png)

6. 设置密码-确认订单就买就完成了， **这里注意，因为我们没有设置防火墙和安全组，我们还加了公网IP，肯定会让所有人能给扫到这台机器尝试暴力破解，存在很大风险，所以密码设置一定要有复杂度** 

![image-20211120140957309](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120140957309.png)

7. 控制台-弹性云服务器ECS

![image-20211120195651014](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120195651014.png)

8. 这时候我们会看到服务器正在创建，等1-2分钟创建好后，IP地址会显示一个弹性公网IP，我的ECS公网IP是`121.37.71.117` , 到此ECS购买完成，你看花钱的速度快不快~

![image-20211120141233259](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120141233259.png)

## 部署Sentry

### 登录和配置ECS

1. 拿到上面的IP，登录云服务器

`ssh root@121.37.71.117`   第一次连接输入`yes` ，然后输入你设置的密码

![image-20211120142219820](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120142219820.png)

2. 当SSH远程命令或者远程工具登录云服务器时，经常会发现SSH连接后一会儿SSH客户端就被服务器T掉，就会失去连接，我们先来设置一下SSH服务（此操作仅为测试，生产环境中请根据生产规范配置）

编辑SSH配置文件 `vim /etc/ssh/sshd_config` ，找到找到以下配置项`ClientAliveInterval` 和`ClientAliveCountMax`  

```
#ClientAliveInterval 0  #服务端每隔多少秒向客户端发送一个心跳数据
#ClientAliveCountMax 3  #客户端多少次没有相应，服务器自动断掉连接
```

去掉注释，改成：

```
ClientClientAliveInterval 60
ClientAliveCountMax 86400
```

保存退出

如图：

![image-20211120142934208](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120142934208.png)



最重要的要重启SSH服务`systemctl restart sshd` ,然后输入`exit` 再重新连接`ssh root@121.37.71.117`  （这里我做了主机信任，所以没用输密码，正常情况下会让输入密码）

![image-20211120202749443](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120202749443.png)

### 准备yum源

这一步也可忽略，如果yum安装包没有问题，可以不用执行此步骤

为了更好的接下来的操作，我把yum源换成阿里的（仅为测试，生产环境请遵守生产规范）

1. 先删除原先的yum源

```
cd /etc/yum.repos.d/
rm -rf *
ls

```



![image-20211120204508834](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120204508834.png)



2. 下载阿里yum源

   ```
   wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo
   ```

   ![image-20211120204727430](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120204727430.png)

   如果提示`wget` 没有安装，也可以用`curl` 来下载

   ```
   curl  -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo
   ```

   



### 安装docker

1. 卸载旧版本

   ```
   yum remove docker \
                     docker-client \
                     docker-client-latest \
                     docker-common \
                     docker-latest \
                     docker-latest-logrotate \
                     docker-logrotate \
                     docker-engine
   ```

2. 安装docker依赖

   ```
   yum install -y yum-utils \
     device-mapper-persistent-data \
     lvm2
   ```

3. 安装docker-ce源

   ```
   yum-config-manager \
       --add-repo \
       https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
   ```

4. 安装docker-ce最新版本(根据官网要求，docker版本不能低于19.03.6)

   ```
   yum install docker-ce docker-ce-cli containerd.io
   ```

5. 启动docker并加入开机自启动

   ```
   systemctl start docker
   
   systemctl enable docker
   ```

6. 验证docker

   ```
   docker run hello-world
   ```

   如图所示，docker安装成功

   ![image-20211120145536494](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120145536494.png)



7. 查看docker版本

   ```
   docker -v
   ```

   ![image-20211120151848080](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120151848080.png)

### 安装Docker-compose



1. [Docker Compose ](https://docs.docker.com/compose/install/)存放在Git Hub，不太稳定。所以我采用国内源来安装docker-compose（官网最低要求docker-compose不能低于1.28.0，安装时注意版本）

   ```
   curl -L https://get.daocloud.io/docker/compose/releases/download/1.28.0/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
   
   chmod +x /usr/local/bin/docker-compose
   ```

   你可以通过修改URL中的版本，可以自定义您的需要的版本。

2. 查看docker-compose的版本

   ```
   docker-compose --version
   ```

   如图所示安装成功：

   ![image-20211120150558892](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120150558892.png)



### 配置阿里云镜像加速

因为镜像都在国外，所以我们配置阿里云容器镜像加速服务

阿里云镜像服务地址：https://cr.console.aliyun.com/cn-beijing/instances

1. 选择镜像工具-镜像加速

![image-20211120220849259](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120220849259.png)



按照文档说的敲就行

```
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://********.mirror.aliyuncs.com"]  #注意要替换成自己的加速地址
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker
```









 ###   配置安全组

因为sentry对外访问的是9000端口，ECS默认没有开放9000端口，所以我们要在安全组打开9000端口，以便能够访问9000

1. 选择云服务器，进入管理页面

   ![image-20211120153450692](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120153450692.png)

2. 选择安全组-更改安全组

   ![image-20211120153531648](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120153531648.png)



3. 新建安全组

![image-20211120153549551](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120153549551.png)

4. 选择创建安全组



![image-20211120153611107](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120153611107.png)



5. 名称-sentry 

   描述：开放sentry服务9000端口

![image-20211120153739067](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120153739067.png)

6. 配置规则

![image-20211120154707281](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120154707281.png)



7. 入方向规则-添加规则

   开放端口：9000

   描述：sentry访问端口

   **源地址注意：0.0.0.0/0代表的是任何人任何地址都能访问的到，这里仅为测试，生产环境不能这样做**

![image-20211120155103447](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120155103447.png)

能够看到我们添加了一条安全组

任何来源IP都能访问此ECS的9000端口

![image-20211120155206672](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120155206672.png)

8. 再进入到ECS管理页面

![image-20211120155319220](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120155319220.png)

9. 选择安全组-更改安全组

![image-20211120155343594](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120155343594.png)

10. 点击下三角，勾选sentry安全组

![image-20211120155413610](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120155413610.png)

如图：确定



![image-20211120155434034](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120155434034.png)



### 安装sentry

1. 先安装git

   ```
   yum -y install git
   ```

2. 获取 [onpremise](https://link.zhihu.com/?target=https%3A//github.com/getsentry/onpremise)

   获取的版本是21.11.0

   ```
   git clone https://github.com/getsentry/onpremise.git
   ```



3. 执行安装脚本

   进入 onpremise 目录执行脚本

   ```
   $ cd onpremise
   $ ./install.sh
   ```

   这个过程稍微有点慢，安装过程中会提示你创建管理者（admin/owner）的账号和密码，请注意留意，按照提示输入即可

   这里我为了测试 Email：test@888.com，正式环境应该填写自己的邮箱

   这一步骤是非必须的，启动时会有一个配置的页面，到时候再根据提示填写也是可以的

   配置文件为 `sentry/config.yml`，需要设置邮件、域名等，具体配置可以参见[官方文档](https://link.zhihu.com/?target=https%3A//develop.sentry.dev/config/)。

   ![image-20211120154626748](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120154626748.png)

   

   4. 看到这一步就算安装完成（根据网速不同，安装时间略有不同，请大家耐心等待，不要终止安装，否则会起不来服务）

   ![image-20211120155128766](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120155128766.png)

4. 启动服务

   ```
   docker-compose up -d
   ```

   ![image-20211120155451220](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120155451220.png)

5. 看一下docker容器是否启动

   ```
   docker ps -a
   ```

   如图都是UP状态![image-20211120163737355](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120163737355.png)

6. 打开控制台-弹性云服务器

   能看到我们的公网IP：`121.37.71.117`![image-20211120155517747](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120155517747.png)

7. 浏览器访问：http://121.37.71.117:9000/

   输入账号密码登录，就是安装过程中你输入的邮箱和密码![image-20211120155656118](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120155656118.png)

8. 配置一些信息 ，我这里为了测试就略过了



![image-20211120155739253](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120155739253.png)



10. 继续下一步

![image-20211120155752342](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120155752342.png)



11.看到sentry的页面

![image-20211120155812708](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120155812708.png)



###  Python Flask接入Sentry

1. 选择Project-Create Project 创建项目



![image-20211120184243619](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120184243619.png)



2. 选择Flask 平台，注意一定要选中Flask图标

   输入项目名字`flask-new` 

   点击Creat Project

![](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120184432869.png)

3. 看到senty教你如何在你项目中接入，接下来我们就按照官方文档接入Flask框架



![image-20211120185759218](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120185759218.png)

4. 用Pycharm创建一个flask项目

   选择Flask框架-输入项目名-选择环境变量

![image-20211120183904703](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120183904703.png)

5. 在终端中安装sentry sdk

   ```
   pip3 install --upgrade 'sentry-sdk[flask]'
   ```

   

![image-20211120184000625](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120184000625.png)

5. 在`app.py` 中写入如下内容：注意dsn要替换成自己sentry服务器上的

```python
import sentry_sdk
from flask import Flask
from sentry_sdk.integrations.flask import FlaskIntegration



sentry_sdk.init(
    dsn="http://7bdfacf1192742ebb217445c50fb2d2f@121.37.71.117:9000/5", #要替换成自己sentry服务器的dns
    integrations=[FlaskIntegration()],

    # Set traces_sample_rate to 1.0 to capture 100%
    # of transactions for performance monitoring.
    # We recommend adjusting this value in production.
    traces_sample_rate=1.0
)

app = Flask(__name__)
```

如图：

![image-20211120183213425](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120183213425.png)

6.模拟一个报错：

1/0会引发ZeroDivisionError错误

```
@app.route('debug-sentry')
def trigger_error():
    division_by_zero=1/0
```

如图：

![image-20211120183229658](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120183229658.png)

浏览器访问：http://127.0.0.1:5000/debug-sentry

能看到报错

![image-20211120183300107](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120183300107.png)

看Pycharm输出也能看到报错：

![image-20211120183525666](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120183525666.png)

7. 浏览器打开sentry页面，选择Project，点击自己刚创建的项目`flask-new` 

![image-20211120183411609](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120183411609.png)

8. 点击`View All Issues` 

![image-20211120184050586](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120184050586.png)

9. 能看到我们的报错和Pycharm输出一样

![image-20211120184114909](/Users/xiaohui.li/Library/Application Support/typora-user-images/image-20211120184114909.png)
